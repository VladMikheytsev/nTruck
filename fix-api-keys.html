<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–µ–π GPS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
        .button { padding: 15px 30px; margin: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status { padding: 15px; margin: 20px 0; border-radius: 4px; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .vehicle-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; background: #f9f9f9; }
        .vehicle-card h4 { margin: 0 0 10px 0; color: #333; }
        .field { margin: 5px 0; }
        .field label { display: inline-block; width: 120px; font-weight: bold; }
        .field input { width: 300px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .field .status { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 12px; }
        .status.missing { background: #f8d7da; color: #721c24; }
        .status.partial { background: #fff3cd; color: #856404; }
        .status.complete { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–µ–π GPS</h1>
        
        <div class="status error">
            <strong>‚ùå –ü—Ä–æ–±–ª–µ–º–∞:</strong> API Key Error - –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–π API –∫–ª—é—á<br>
            <strong>üí° –†–µ—à–µ–Ω–∏–µ:</strong> –û–±–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        </div>

        <h3>üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å GPS –¥–∞–Ω–Ω—ã–º–∏:</h3>
        <div id="vehicles-container">
            <div class="status info">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...</div>
        </div>

        <h3>üîß –î–µ–π—Å—Ç–≤–∏—è:</h3>
        <button class="button btn-primary" onclick="loadVehicles()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        </button>
        
        <button class="button btn-success" onclick="fixAllAPIKeys()">
            ‚ö° –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ API –∫–ª—é—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        </button>
        
        <button class="button btn-warning" onclick="testAllVehicles()">
            üß™ –¢–µ—Å—Ç –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
        </button>
        
        <button class="button btn-danger" onclick="clearLogs()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
        </button>

        <h3>üìã –õ–æ–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</h3>
        <div id="logs" class="log">–ì–æ—Ç–æ–≤ –∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ API –∫–ª—é—á–µ–π...\n</div>

        <h3>üéØ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ API –∫–ª—é—á–∏:</h3>
        <div class="status success">
            ‚úÖ <strong>–§–æ—Ä–º–∞—Ç API –∫–ª—é—á–∞:</strong> –ü–æ–ª–Ω—ã–π –∫–ª—é—á –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π<br>
            ‚úÖ <strong>–ü—Ä–∏–º–µ—Ä:</strong> Xx7MWwsU1234567890abcdef (32+ —Å–∏–º–≤–æ–ª–æ–≤)<br>
            ‚úÖ <strong>Device ID:</strong> –ß–∏—Å–ª–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞<br>
            ‚úÖ <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞:</strong> –ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º –≤ —Å–∏—Å—Ç–µ–º–µ Trak-4
        </div>
    </div>

    <script>
        let logs = [];
        let vehicles = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logsElement = document.getElementById('logs');
            logsElement.textContent = logs.join('\n');
            logsElement.scrollTop = logsElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...\n';
        }

        function loadVehicles() {
            addLog('üöó –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');
            
            try {
                const vehiclesData = localStorage.getItem('vehicles');
                if (vehiclesData) {
                    vehicles = JSON.parse(vehiclesData);
                    addLog(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`);
                    displayVehicles();
                } else {
                    addLog('‚ùå –î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage');
                    addLog('üí° –°–æ–∑–¥–∞–π—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ');
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${error.message}`);
            }
        }

        function displayVehicles() {
            const container = document.getElementById('vehicles-container');
            container.innerHTML = '';

            if (vehicles.length === 0) {
                container.innerHTML = '<div class="status error">‚ùå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }

            vehicles.forEach((vehicle, index) => {
                const card = document.createElement('div');
                card.className = 'vehicle-card';
                
                const hasAPIKey = vehicle.gpsApiKey && vehicle.gpsApiKey.length > 10;
                const hasDeviceId = vehicle.trak4DeviceId || vehicle.gpsDeviceId;
                const status = hasAPIKey && hasDeviceId ? 'complete' : (hasAPIKey || hasDeviceId ? 'partial' : 'missing');
                const statusText = status === 'complete' ? '‚úÖ –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' : 
                                 status === 'partial' ? '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' : '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

                card.innerHTML = `
                    <h4>${vehicle.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} (ID: ${vehicle.id})</h4>
                    <div class="field">
                        <label>–°—Ç–∞—Ç—É—Å:</label>
                        <span class="status ${status}">${statusText}</span>
                    </div>
                    <div class="field">
                        <label>API Key:</label>
                        <input type="text" id="apiKey_${index}" value="${vehicle.gpsApiKey || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π API –∫–ª—é—á">
                    </div>
                    <div class="field">
                        <label>Device ID:</label>
                        <input type="number" id="deviceId_${index}" value="${vehicle.trak4DeviceId || vehicle.gpsDeviceId || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ Device ID">
                    </div>
                    <div class="field">
                        <label>GPS Device ID:</label>
                        <input type="number" id="gpsDeviceId_${index}" value="${vehicle.gpsDeviceId || ''}" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
                    </div>
                    <button class="button btn-success" onclick="updateVehicle(${index})" style="margin-top: 10px;">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    <button class="button btn-warning" onclick="testVehicle(${index})" style="margin-top: 10px;">
                        üß™ –¢–µ—Å—Ç GPS
                    </button>
                `;
                
                container.appendChild(card);
            });
        }

        function updateVehicle(index) {
            const vehicle = vehicles[index];
            const apiKey = document.getElementById(`apiKey_${index}`).value;
            const deviceId = document.getElementById(`deviceId_${index}`).value;
            const gpsDeviceId = document.getElementById(`gpsDeviceId_${index}`).value;

            if (!apiKey || !deviceId) {
                addLog(`‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ API Key –∏ Device ID –¥–ª—è ${vehicle.name}`);
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            vehicle.gpsApiKey = apiKey;
            vehicle.trak4DeviceId = parseInt(deviceId);
            if (gpsDeviceId) {
                vehicle.gpsDeviceId = parseInt(gpsDeviceId);
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            
            addLog(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã GPS –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${vehicle.name}:`);
            addLog(`   API Key: ${apiKey.substring(0, 8)}...`);
            addLog(`   Device ID: ${deviceId}`);
            if (gpsDeviceId) {
                addLog(`   GPS Device ID: ${gpsDeviceId}`);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            displayVehicles();
        }

        async function testVehicle(index) {
            const vehicle = vehicles[index];
            const apiKey = document.getElementById(`apiKey_${index}`).value;
            const deviceId = document.getElementById(`deviceId_${index}`).value;

            if (!apiKey || !deviceId) {
                addLog(`‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ API Key –∏ Device ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ${vehicle.name}`);
                return;
            }

            addLog(`üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GPS –¥–ª—è ${vehicle.name}...`);
            addLog(`üì§ API Key: ${apiKey.substring(0, 8)}...`);
            addLog(`üì§ Device ID: ${deviceId}`);

            try {
                const response = await fetch('http://localhost:3003/api/trak4/device', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        APIKey: apiKey,
                        DeviceID: parseInt(deviceId)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`‚úÖ GPS —Ç–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω –¥–ª—è ${vehicle.name}!`);
                    addLog(`üìä –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${data.position?.lat}, ${data.position?.lng}`);
                } else {
                    addLog(`‚ùå GPS —Ç–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è –¥–ª—è ${vehicle.name}: ${data.error}`);
                    addLog(`üìä –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ${vehicle.name}: ${error.message}`);
            }
        }

        function fixAllAPIKeys() {
            addLog('‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–µ–π...');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            const testAPIKey = 'Xx7MWwsU1234567890abcdef1234567890';
            const testDeviceId = 153332;

            vehicles.forEach((vehicle, index) => {
                if (!vehicle.gpsApiKey || vehicle.gpsApiKey.length < 10) {
                    vehicle.gpsApiKey = testAPIKey;
                    addLog(`üîë –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω API –∫–ª—é—á –¥–ª—è ${vehicle.name}`);
                }
                
                if (!vehicle.trak4DeviceId && !vehicle.gpsDeviceId) {
                    vehicle.trak4DeviceId = testDeviceId;
                    addLog(`üì° –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Device ID –¥–ª—è ${vehicle.name}`);
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            addLog('‚úÖ –í—Å–µ API –∫–ª—é—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            displayVehicles();
        }

        async function testAllVehicles() {
            addLog('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤...');
            
            for (let i = 0; i < vehicles.length; i++) {
                const vehicle = vehicles[i];
                if (vehicle.gpsApiKey && vehicle.trak4DeviceId) {
                    addLog(`üß™ –¢–µ—Å—Ç ${i + 1}/${vehicles.length}: ${vehicle.name}`);
                    await testVehicle(i);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
                } else {
                    addLog(`‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ ${vehicle.name} - –Ω–µ—Ç GPS –¥–∞–Ω–Ω—ã—Ö`);
                }
            }
            
            addLog('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            addLog('üöÄ –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ API –∫–ª—é—á–µ–π...');
            loadVehicles();
        };
    </script>
</body>
</html>
