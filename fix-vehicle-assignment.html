<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .output { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—è–º</h1>
        
        <div class="status error">
            <strong>‚ùå –ü—Ä–æ–±–ª–µ–º–∞:</strong> "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—è–º."
        </div>

        <h3>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</h3>
        <button class="button btn-primary" onclick="diagnoseAssignments()">1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</button>
        <button class="button btn-warning" onclick="showCurrentAssignments()">2. –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</button>
        <button class="button btn-success" onclick="autoAssignVehicles()">3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
        <button class="button btn-danger" onclick="clearAssignments()">4. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</button>

        <div id="output" class="output">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...</div>

        <div class="grid">
            <div class="card">
                <h4>üë• –í–æ–¥–∏—Ç–µ–ª–∏</h4>
                <div id="drivers-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="card">
                <h4>üöö –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h4>
                <div id="vehicles-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <h3>üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h3>
        <button class="button btn-success" onclick="quickFixAssignments()">üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
    </div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function updateDriversList() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const drivers = users.filter(user => user.role === 'driver');
            
            const driversDiv = document.getElementById('drivers-list');
            driversDiv.innerHTML = drivers.map(driver => 
                `<div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                    üë§ ${driver.firstName} ${driver.lastName} (ID: ${driver.id})
                </div>`
            ).join('');
        }

        function updateVehiclesList() {
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            
            const vehiclesDiv = document.getElementById('vehicles-list');
            vehiclesDiv.innerHTML = vehicles.map(vehicle => 
                `<div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                    üöö ${vehicle.name} (ID: ${vehicle.id})<br>
                    <small style="color: #666;">–ù–∞–∑–Ω–∞—á–µ–Ω: ${vehicle.assignedDriver || '–ù–ï –ù–ê–ó–ù–ê–ß–ï–ù'}</small>
                </div>`
            ).join('');
        }

        function diagnoseAssignments() {
            log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');
            
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
                const routes = JSON.parse(localStorage.getItem('routes') || '[]');
                const workSchedules = JSON.parse(localStorage.getItem('workSchedules') || '[]');
                
                const drivers = users.filter(user => user.role === 'driver');
                log(`üë• –ù–∞–π–¥–µ–Ω–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π: ${drivers.length}`);
                log(`üöö –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.length}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                let assignedVehicles = 0;
                let unassignedDrivers = 0;
                
                drivers.forEach(driver => {
                    const driverFullName = `${driver.firstName} ${driver.lastName}`;
                    const assignedVehicle = vehicles.find(v => v.assignedDriver === driverFullName);
                    
                    if (assignedVehicle) {
                        assignedVehicles++;
                        log(`‚úÖ ${driverFullName} ‚Üí ${assignedVehicle.name}`);
                    } else {
                        unassignedDrivers++;
                        log(`‚ùå ${driverFullName} ‚Üí –ù–ï–¢ –ù–ê–ó–ù–ê–ß–ï–ù–ù–û–ì–û –¢–†–ê–ù–°–ü–û–†–¢–ê`);
                    }
                });
                
                log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ ${assignedVehicles} –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π, ‚ùå ${unassignedDrivers} –±–µ–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                
                let todayRoutesWithVehicles = 0;
                
                drivers.forEach(driver => {
                    const schedule = workSchedules.find(ws => 
                        ws.driverId === driver.id && ws.year === year && ws.month === month
                    );
                    
                    if (schedule && schedule.schedule[day]) {
                        const routeId = schedule.schedule[day];
                        const route = routes.find(r => r.id === routeId);
                        const driverFullName = `${driver.firstName} ${driver.lastName}`;
                        const vehicle = vehicles.find(v => v.assignedDriver === driverFullName);
                        
                        if (route && vehicle) {
                            todayRoutesWithVehicles++;
                            log(`‚úÖ –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç —Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º: ${route.name} ‚Üí ${driverFullName} ‚Üí ${vehicle.name}`);
                        } else if (route && !vehicle) {
                            log(`‚ùå –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –ë–ï–ó —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${route.name} ‚Üí ${driverFullName} ‚Üí –ù–ï–¢ –¢–†–ê–ù–°–ü–û–†–¢–ê`);
                        }
                    }
                });
                
                log(`üìÖ –°–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º: ${todayRoutesWithVehicles}`);
                
                if (todayRoutesWithVehicles === 0) {
                    log('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ù–ï–¢ –°–ï–ì–û–î–ù–Ø–®–ù–ò–• –ú–ê–†–®–†–£–¢–û–í –° –ù–ê–ó–ù–ê–ß–ï–ù–ù–´–ú –¢–†–ê–ù–°–ü–û–†–¢–û–ú!');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`);
            }
        }

        function showCurrentAssignments() {
            log('üìã –¢–µ–∫—É—â–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');
            
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
                
                const drivers = users.filter(user => user.role === 'driver');
                
                log('üë• –í–û–î–ò–¢–ï–õ–ò:');
                drivers.forEach(driver => {
                    log(`   ${driver.firstName} ${driver.lastName} (ID: ${driver.id})`);
                });
                
                log('\nüöö –¢–†–ê–ù–°–ü–û–†–¢:');
                vehicles.forEach(vehicle => {
                    log(`   ${vehicle.name} (ID: ${vehicle.id}) ‚Üí –ù–∞–∑–Ω–∞—á–µ–Ω: ${vehicle.assignedDriver || '–ù–ï –ù–ê–ó–ù–ê–ß–ï–ù'}`);
                });
                
                log('\nüîó –°–í–Ø–ó–ò:');
                drivers.forEach(driver => {
                    const driverFullName = `${driver.firstName} ${driver.lastName}`;
                    const assignedVehicle = vehicles.find(v => v.assignedDriver === driverFullName);
                    
                    if (assignedVehicle) {
                        log(`   ‚úÖ ${driverFullName} ‚Üî ${assignedVehicle.name}`);
                    } else {
                        log(`   ‚ùå ${driverFullName} ‚Üî –ù–ï–¢ –°–í–Ø–ó–ò`);
                    }
                });
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π: ${error.message}`);
            }
        }

        function autoAssignVehicles() {
            log('ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');
            
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
                
                const drivers = users.filter(user => user.role === 'driver');
                const unassignedVehicles = vehicles.filter(v => !v.assignedDriver);
                
                log(`üë• –í–æ–¥–∏—Ç–µ–ª–µ–π –±–µ–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${drivers.filter(d => {
                    const driverFullName = `${d.firstName} ${d.lastName}`;
                    return !vehicles.find(v => v.assignedDriver === driverFullName);
                }).length}`);
                log(`üöö –°–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${unassignedVehicles.length}`);
                
                let assigned = 0;
                
                drivers.forEach((driver, index) => {
                    const driverFullName = `${driver.firstName} ${driver.lastName}`;
                    const hasVehicle = vehicles.find(v => v.assignedDriver === driverFullName);
                    
                    if (!hasVehicle && unassignedVehicles[index]) {
                        const vehicle = unassignedVehicles[index];
                        vehicle.assignedDriver = driverFullName;
                        assigned++;
                        log(`‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω: ${driverFullName} ‚Üí ${vehicle.name}`);
                    }
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                
                log(`üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ: ${assigned} —Å–≤—è–∑–µ–π`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                updateVehiclesList();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${error.message}`);
            }
        }

        function clearAssignments() {
            log('üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π...');
            
            try {
                const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
                
                vehicles.forEach(vehicle => {
                    if (vehicle.assignedDriver) {
                        log(`üóëÔ∏è –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ: ${vehicle.assignedDriver} ‚Üê ${vehicle.name}`);
                        vehicle.assignedDriver = '';
                    }
                });
                
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                
                log('‚úÖ –í—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã');
                updateVehiclesList();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${error.message}`);
            }
        }

        function quickFixAssignments() {
            log('üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π...');
            
            // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
            clearAssignments();
            
            setTimeout(() => {
                // –ó–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º
                autoAssignVehicles();
                
                setTimeout(() => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    diagnoseAssignments();
                    
                    setTimeout(() => {
                        log('‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
                        log('üéØ –¢–µ–ø–µ—Ä—å –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Dashboard ‚Üí –ú–∞—Ä—à—Ä—É—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ"');
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        window.onload = function() {
            log('üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ...');
            updateDriversList();
            updateVehiclesList();
            diagnoseAssignments();
        };
    </script>
</body>
</html>
