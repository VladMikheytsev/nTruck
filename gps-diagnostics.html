<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - NTruck</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover {
            background: #5a6268;
        }
        
        .log {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .fix-instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .fix-instructions h4 {
            color: #0066cc;
            margin-top: 0;
        }
        .fix-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .fix-instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç GPS –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ NTruck</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ GPS –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h3>üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div id="generalInfo"></div>
            </div>
            
            <div class="section">
                <h3>üë• –í–æ–¥–∏—Ç–µ–ª–∏</h3>
                <div id="driversInfo"></div>
            </div>
            
            <div class="section">
                <h3>üöö –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h3>
                <div id="vehiclesInfo"></div>
            </div>
            
            <div class="section">
                <h3>üè¢ –°–∫–ª–∞–¥—ã</h3>
                <div id="warehousesInfo"></div>
            </div>
            
            <div class="section">
                <h3>üîó –°–≤—è–∑–∏ –≤–æ–¥–∏—Ç–µ–ª—å-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h3>
                <div id="connectionsInfo"></div>
            </div>
            
            <div class="section">
                <h3>üì° GPS –¢–µ—Å—Ç</h3>
                <button class="btn" onclick="testGPS()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å GPS</button>
                <div id="gpsTestResults"></div>
            </div>
            
            <div class="section">
                <h3>üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                <div id="fixInstructions"></div>
            </div>
            
            <div class="section">
                <h3>üìù –õ–æ–≥–∏</h3>
                <button class="btn secondary" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <div id="log" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function loadAppData() {
            try {
                const appDataStr = localStorage.getItem('ntruck_app_data');
                if (!appDataStr) {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage');
                    return null;
                }
                return JSON.parse(appDataStr);
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                return null;
            }
        }

        function displayGeneralInfo() {
            const appData = loadAppData();
            if (!appData) return;

            const drivers = appData.users?.filter(u => u.role === 'driver') || [];
            const vehicles = appData.vehicles || [];
            const warehouses = appData.warehouses || [];
            const requests = appData.transferRequests || [];

            document.getElementById('generalInfo').innerHTML = `
                <div class="status info">
                    üìä –í—Å–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π: ${drivers.length} | 
                    –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${vehicles.length} | 
                    –°–∫–ª–∞–¥–æ–≤: ${warehouses.length} | 
                    –ó–∞—è–≤–æ–∫: ${requests.length}
                </div>
            `;
        }

        function displayDrivers() {
            const appData = loadAppData();
            if (!appData) return;

            const drivers = appData.users?.filter(u => u.role === 'driver') || [];
            
            let html = '<table class="data-table"><tr><th>ID</th><th>–ò–º—è</th><th>–õ–æ–≥–∏–Ω</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–°–∫–ª–∞–¥</th></tr>';
            
            drivers.forEach(driver => {
                const warehouse = appData.warehouses?.find(w => w.id === driver.warehouseId);
                html += `
                    <tr>
                        <td>${driver.id}</td>
                        <td>${driver.firstName} ${driver.lastName}</td>
                        <td>${driver.login}</td>
                        <td>${driver.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        <td>${warehouse?.name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            document.getElementById('driversInfo').innerHTML = html;
        }

        function displayVehicles() {
            const appData = loadAppData();
            if (!appData) return;

            const vehicles = appData.vehicles || [];
            
            let html = '<table class="data-table"><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–í–æ–¥–∏—Ç–µ–ª—å</th><th>GPS API</th><th>Device ID</th><th>–°—Ç–∞—Ç—É—Å</th></tr>';
            
            vehicles.forEach(vehicle => {
                const hasApiKey = !!vehicle.gpsApiKey;
                const hasDeviceId = !!(vehicle.gpsDeviceId || vehicle.trak4DeviceId);
                const gpsStatus = hasApiKey && hasDeviceId ? 'success' : 'error';
                
                html += `
                    <tr>
                        <td>${vehicle.id}</td>
                        <td>${vehicle.name}</td>
                        <td>${vehicle.assignedDriver || vehicle.driverId || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
                        <td class="status ${hasApiKey ? 'success' : 'error'}">
                            ${hasApiKey ? '‚úì –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                        </td>
                        <td class="status ${hasDeviceId ? 'success' : 'error'}">
                            ${hasDeviceId ? `‚úì ${vehicle.gpsDeviceId || vehicle.trak4DeviceId}` : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                        </td>
                        <td>${vehicle.status || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            document.getElementById('vehiclesInfo').innerHTML = html;
        }

        function displayWarehouses() {
            const appData = loadAppData();
            if (!appData) return;

            const warehouses = appData.warehouses || [];
            
            let html = '<table class="data-table"><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–¥—Ä–µ—Å</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th></tr>';
            
            warehouses.forEach(warehouse => {
                const hasCoords = !!(warehouse.coordinates?.lat && warehouse.coordinates?.lng);
                const employee = appData.users?.find(u => u.id === warehouse.assignedEmployee);
                
                html += `
                    <tr>
                        <td>${warehouse.id}</td>
                        <td>${warehouse.name}</td>
                        <td>${warehouse.fullAddress}</td>
                        <td class="status ${hasCoords ? 'success' : 'error'}">
                            ${hasCoords ? `‚úì ${warehouse.coordinates.lat}, ${warehouse.coordinates.lng}` : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã'}
                        </td>
                        <td>${employee ? `${employee.firstName} ${employee.lastName}` : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            document.getElementById('warehousesInfo').innerHTML = html;
        }

        function displayConnections() {
            const appData = loadAppData();
            if (!appData) return;

            const drivers = appData.users?.filter(u => u.role === 'driver') || [];
            const vehicles = appData.vehicles || [];
            
            let html = '<table class="data-table"><tr><th>–í–æ–¥–∏—Ç–µ–ª—å</th><th>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</th><th>GPS –ù–∞—Å—Ç—Ä–æ–π–∫–∏</th><th>–°—Ç–∞—Ç—É—Å</th></tr>';
            
            drivers.forEach(driver => {
                const driverFullName = `${driver.firstName} ${driver.lastName}`;
                const vehicle = vehicles.find(v => 
                    v.driverId === driver.id || 
                    v.assignedDriver === driver.id ||
                    v.assignedDriver === driverFullName
                );
                
                if (vehicle) {
                    const hasApiKey = !!vehicle.gpsApiKey;
                    const hasDeviceId = !!(vehicle.gpsDeviceId || vehicle.trak4DeviceId);
                    const gpsComplete = hasApiKey && hasDeviceId;
                    
                    html += `
                        <tr>
                            <td>${driverFullName}</td>
                            <td>${vehicle.name}</td>
                            <td class="status ${gpsComplete ? 'success' : 'error'}">
                                ${gpsComplete ? '‚úì –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ–ø–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞'}
                            </td>
                            <td class="status ${gpsComplete ? 'success' : 'warning'}">
                                ${gpsComplete ? '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ' : '–¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'}
                            </td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr>
                            <td>${driverFullName}</td>
                            <td>‚ùå –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</td>
                            <td>‚ùå –ù–µ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</td>
                            <td class="status error">–¢—Ä–µ–±—É–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</td>
                        </tr>
                    `;
                }
            });
            
            html += '</table>';
            document.getElementById('connectionsInfo').innerHTML = html;
        }

        async function testGPS() {
            log('üß™ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç GPS...');
            
            const appData = loadAppData();
            if (!appData) {
                log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                return;
            }

            const vehicles = appData.vehicles || [];
            const vehiclesWithGPS = vehicles.filter(v => v.gpsApiKey && (v.gpsDeviceId || v.trak4DeviceId));
            
            if (vehiclesWithGPS.length === 0) {
                document.getElementById('gpsTestResults').innerHTML = `
                    <div class="status error">
                        ‚ùå –ù–µ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º GPS
                    </div>
                `;
                return;
            }

            let resultsHtml = '<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã GPS —Ç–µ—Å—Ç–æ–≤:</h4>';
            
            for (const vehicle of vehiclesWithGPS.slice(0, 3)) { // –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º—É–º 3 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
                log(`üì° –¢–µ—Å—Ç–∏—Ä—É–µ–º GPS –¥–ª—è ${vehicle.name}...`);
                
                try {
                    const response = await fetch('http://localhost:3001/api/trak4/device', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            APIKey: vehicle.gpsApiKey,
                            DeviceID: parseInt(String(vehicle.gpsDeviceId || vehicle.trak4DeviceId))
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.Device) {
                            const device = data.Device;
                            const lat = device.LastReport_Latitude || device.Latitude || device.Position_Latitude;
                            const lng = device.LastReport_Longitude || device.Longitude || device.Position_Longitude;
                            
                            resultsHtml += `
                                <div class="status success">
                                    ‚úÖ ${vehicle.name}: GPS —Ä–∞–±–æ—Ç–∞–µ—Ç (${lat}, ${lng})
                                </div>
                            `;
                            log(`‚úÖ ${vehicle.name}: GPS —Ä–∞–±–æ—Ç–∞–µ—Ç`);
                        } else {
                            resultsHtml += `
                                <div class="status error">
                                    ‚ùå ${vehicle.name}: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                                </div>
                            `;
                            log(`‚ùå ${vehicle.name}: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞`);
                        }
                    } else {
                        const errorData = await response.json();
                        resultsHtml += `
                            <div class="status error">
                                ‚ùå ${vehicle.name}: –û—à–∏–±–∫–∞ API (${response.status})
                            </div>
                        `;
                        log(`‚ùå ${vehicle.name}: –û—à–∏–±–∫–∞ API ${response.status}`);
                    }
                } catch (error) {
                    resultsHtml += `
                        <div class="status error">
                            ‚ùå ${vehicle.name}: –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
                        </div>
                    `;
                    log(`‚ùå ${vehicle.name}: –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ - ${error.message}`);
                }
            }
            
            document.getElementById('gpsTestResults').innerHTML = resultsHtml;
        }

        function displayFixInstructions() {
            const appData = loadAppData();
            if (!appData) return;

            const drivers = appData.users?.filter(u => u.role === 'driver') || [];
            const vehicles = appData.vehicles || [];
            const warehouses = appData.warehouses || [];
            
            let issues = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π –±–µ–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            const driversWithoutVehicles = drivers.filter(driver => {
                const driverFullName = `${driver.firstName} ${driver.lastName}`;
                return !vehicles.find(v => 
                    v.driverId === driver.id || 
                    v.assignedDriver === driver.id ||
                    v.assignedDriver === driverFullName
                );
            });
            
            if (driversWithoutVehicles.length > 0) {
                issues.push(`–í–æ–¥–∏—Ç–µ–ª–∏ –±–µ–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${driversWithoutVehicles.map(d => `${d.firstName} ${d.lastName}`).join(', ')}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –±–µ–∑ GPS
            const vehiclesWithoutGPS = vehicles.filter(v => !v.gpsApiKey || (!v.gpsDeviceId && !v.trak4DeviceId));
            if (vehiclesWithoutGPS.length > 0) {
                issues.push(`–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –±–µ–∑ GPS: ${vehiclesWithoutGPS.map(v => v.name).join(', ')}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–ª–∞–¥—ã –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const warehousesWithoutCoords = warehouses.filter(w => !w.coordinates?.lat || !w.coordinates?.lng);
            if (warehousesWithoutCoords.length > 0) {
                issues.push(`–°–∫–ª–∞–¥—ã –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ${warehousesWithoutCoords.map(w => w.name).join(', ')}`);
            }
            
            let html = '';
            
            if (issues.length === 0) {
                html = '<div class="status success">‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!</div>';
            } else {
                html = '<div class="fix-instructions"><h4>üîß –¢—Ä–µ–±—É—é—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</h4><ol>';
                issues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ol></div>';
            }
            
            document.getElementById('fixInstructions').innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ –ó–∞–ø—É—Å–∫ GPS –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            displayGeneralInfo();
            displayDrivers();
            displayVehicles();
            displayWarehouses();
            displayConnections();
            displayFixInstructions();
            log('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        });
    </script>
</body>
</html>
